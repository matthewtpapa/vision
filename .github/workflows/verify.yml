name: verify

on:
  push:
    branches: [ main ]
    paths-ignore: [ '**/*.md' ]
  pull_request:
    branches: [ main ]
    paths-ignore: [ '**/*.md' ]

permissions:
  contents: read

jobs:
  verify:
    name: verify (${{ matrix.python-version }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: [ "3.10", "3.11" ]
    concurrency:
      group: verify-${{ github.ref }}-${{ matrix.python-version }}
      cancel-in-progress: true

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip
          cache-dependency-path: requirements-dev.txt

      - name: Purge stale site-packages
        run: |
          python - <<'PY'
          import pathlib, shutil, site, sys
          for s in filter(None, site.getsitepackages() + [site.getusersitepackages()]):
              for p in pathlib.Path(s).glob("latency_vision*"):
                  print("removing stale", p, file=sys.stderr)
                  shutil.rmtree(p, ignore_errors=True)
          PY

      - run: pip install -r requirements-dev.txt
      - run: pip install -e .

      - name: Lint/Format/Types
        run: make verify-static

      - name: Tests (quiet)
        run: pytest -q

      - name: Upload basic artifacts (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: verify-${{ matrix.python-version }}
          path: |
            .pytest_cache
            .mypy_cache
            gate_summary.txt
